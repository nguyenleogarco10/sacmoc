<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sắc Mộc - Thử Son Ảo </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/vision_bundle.js"></script>
    <style>
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #FDFBF8;
            color: #4A4A4A;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
        }
        .text-brand { color: #8D6E63; }
        #vto-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 900px;
        }
        #vto-video-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            aspect-ratio: 4 / 3;
            background-color: #EFEBE9;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        #vto-video, #vto-canvas, #vto-face-static {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #vto-video {
            transform: scaleX(-1); /* Mirror mode */
        }
        #vto-canvas, #vto-lips-overlay {
            pointer-events: none;
        }
        #vto-lips-overlay {
             position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Default clip-path, will be updated if VTO fails */
            clip-path: polygon(29% 62%, 35% 58%, 43% 56%, 50% 57%, 57% 56%, 65% 58%, 71% 62%, 65% 66%, 57% 68%, 50% 69%, 43% 68%, 35% 66%);
        }
        #vto-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            max-width: 500px;
        }
        #vto-color-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
            gap: 0.75rem;
            width: 100%;
        }
        .vto-color-btn {
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 0.375rem;
            border: 2px solid transparent;
            cursor: pointer;
            transition: border-color 0.2s ease-in-out;
        }
        .vto-color-btn:hover, .vto-color-btn.active {
            border-color: #8D6E63;
            box-shadow: 0 0 0 2px #D7CCC8;
        }
        #vto-status {
            text-align: center;
            padding: 0.5rem;
            background-color: rgba(255,255,255,0.8);
            border-radius: 0.375rem;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="vto-container">
        <h1 class="text-3xl font-bold text-brand mb-4">Thử Son Ảo - Sắc Mộc </h1>
        
        <div id="vto-video-container">
            <img id="vto-face-static" src="https://placehold.co/600x400/EFEBE9/8D6E63?text=Xem+trước+tĩnh" alt="Khuôn mặt mẫu" class="hidden">
            <video id="vto-video" playsinline autoplay muted></video>
            <canvas id="vto-canvas"></canvas>
            <div id="vto-lips-overlay" class="hidden"></div>
            <p id="vto-status">Đang tải...</p>
        </div>

        <div id="vto-controls">
            <h4 class="font-semibold text-gray-700">Chọn màu son của bạn:</h4>
            <div id="vto-color-options"></div>
            <div class="mt-2 p-3 bg-amber-100 border-l-4 border-amber-500 text-amber-700 text-sm w-full">
                <p><strong>Lưu ý:</strong> Để có kết quả tốt nhất, hãy đảm bảo khuôn mặt bạn được chiếu sáng đủ và nhìn thẳng vào webcam.</p>
                <p id="vto-fallback-note" class="hidden mt-1">Chế độ xem trước AI không khả dụng, đang hiển thị bản xem trước tĩnh.</p>
            </div>
        </div>
    </div>

    <script type="module">
        // Dynamically import MediaPipe Tasks Vision components
        const { FaceLandmarker, FilesetResolver } = await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/vision_bundle.js");

        const vtoVideo = document.getElementById('vto-video');
        const vtoCanvas = document.getElementById('vto-canvas');
        const vtoFaceStatic = document.getElementById('vto-face-static');
        const vtoLipsOverlay = document.getElementById('vto-lips-overlay');
        const vtoCtx = vtoCanvas.getContext('2d');
        const vtoColorOptions = document.getElementById('vto-color-options');
        const vtoStatus = document.getElementById('vto-status');
        const vtoFallbackNote = document.getElementById('vto-fallback-note');

        let faceLandmarker;
        let currentLipColor = 'rgba(185, 92, 80, 0.7)'; // Default color
        let videoStream;
        let animationFrameId;
        let advancedVtoAvailable = false;
        let lastVideoTime = -1;

        // These landmark indices are standard for MediaPipe Face Mesh (478 landmarks model)
        // and should map to lips.
        const LIP_OUTLINE_UPPER = [61,185,40,39,37,0,267,269,270,409,291,308,415,310,311,312,13,82,81,80,191,78];
        const LIP_OUTLINE_LOWER = [61,146,91,181,84,17,314,405,321,375,291,324,318,402,317,14,87,178,88,95,78];


        const products = [
            { name: 'Đỏ Đất - 01', color: '#B95C50'},
            { name: 'Cam Cháy - 02', color: '#D87C4F'},
            { name: 'Hồng Đào - 03', color: '#E48F82'},
            { name: 'Nâu Gỗ - 04', color: '#8C5A4D'},
            { name: 'Hồng Đất - 05', color: '#C68582'}
        ];

        products.forEach(p => {
            const colorBtn = document.createElement('button');
            colorBtn.className = 'vto-color-btn';
            colorBtn.style.backgroundColor = p.color;
            colorBtn.dataset.color = p.color;
            colorBtn.setAttribute('aria-label', `Thử màu ${p.name}`);
            colorBtn.addEventListener('click', () => {
                currentLipColor = hexToRgba(p.color, 0.6);
                document.querySelectorAll('.vto-color-btn').forEach(btn => btn.classList.remove('active'));
                colorBtn.classList.add('active');
                if (!advancedVtoAvailable) {
                    vtoLipsOverlay.style.backgroundColor = currentLipColor;
                }
            });
            vtoColorOptions.appendChild(colorBtn);
        });
        if (vtoColorOptions.firstElementChild) {
            vtoColorOptions.firstElementChild.click();
        }

        async function setupWebcam() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: 'user' }, 
                    audio: false 
                });
                vtoVideo.srcObject = videoStream;
                return new Promise((resolve) => {
                    vtoVideo.onloadedmetadata = () => {
                        vtoVideo.play().then(() => { // Autoplay after metadata is loaded
                           resolve(true);
                        }).catch(e => {
                           console.error("Error auto-playing video:", e);
                           resolve(false); // Could not play
                        });
                    }
                    vtoVideo.onerror = () => { // Handle video error
                        console.error("Video error.");
                        resolve(false);
                    }
                });
            } catch (err) {
                console.error("Error accessing webcam:", err);
                vtoStatus.textContent = "Không thể truy cập webcam. Vui lòng cấp quyền.";
                advancedVtoAvailable = false;
                return false;
            }
        }
        
        async function createFaceLandmarker() {
            vtoStatus.textContent = "Đang khởi tạo AI...";
            advancedVtoAvailable = false;
            try {
                const filesetResolver = await FilesetResolver.forVisionTasks(
                    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
                );
                faceLandmarker = await FaceLandmarker.createFromOptions(filesetResolver, {
                    baseOptions: {
                        modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`,
                        delegate: "GPU" // Or "CPU"
                    },
                    outputFaceBlendshapes: false, // Not needed for simple lipstick
                    outputFacialTransformationMatrixes: false, // Not needed
                    runningMode: "VIDEO", // Important for video processing
                    numFaces: 1
                });
                console.log("FaceLandmarker created successfully.");
                advancedVtoAvailable = true;
                return true;
            } catch (error) {
                console.error("Lỗi khi tạo FaceLandmarker:", error);
                vtoStatus.textContent = "Lỗi khởi tạo AI. Chuyển sang xem trước tĩnh.";
                advancedVtoAvailable = false;
                return false;
            }
        }
        
        function hexToRgba(hex, alpha = 0.7) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function activateStaticPreview() {
            console.log("Activating static preview mode.");
            vtoVideo.classList.add('hidden');
            vtoCanvas.classList.add('hidden');
            vtoFaceStatic.classList.remove('hidden');
            vtoLipsOverlay.classList.remove('hidden');
            vtoLipsOverlay.style.backgroundColor = currentLipColor;
            vtoStatus.textContent = "Xem trước tĩnh (AI không khả dụng).";
            vtoStatus.style.display = 'block';
            vtoFallbackNote.classList.remove('hidden');

            if (videoStream) { 
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
                vtoVideo.srcObject = null;
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
        }

        function activateAdvancedPreview() {
            console.log("Attempting to activate advanced preview mode.");
            vtoFaceStatic.classList.add('hidden');
            vtoLipsOverlay.classList.add('hidden'); // Hide static overlay
            vtoVideo.classList.remove('hidden');
            vtoCanvas.classList.remove('hidden');
            vtoFallbackNote.classList.add('hidden');
            vtoStatus.textContent = "Đang nhận diện..."; // Initial status
        }

        function drawLipstick(landmarks) {
            vtoCtx.clearRect(0, 0, vtoCanvas.width, vtoCanvas.height);
            if (!landmarks || landmarks.length === 0) {
                return;
            }

            vtoCtx.fillStyle = currentLipColor;

            // Draw Upper Lip - Adjusted for mirrored video
            vtoCtx.beginPath();
            const upperLipPoints = LIP_OUTLINE_UPPER.map(idx => ({
                // Flip X coordinate: (1 - normalizedX) * canvasWidth
                x: (1 - landmarks[idx].x) * vtoCanvas.width, 
                y: landmarks[idx].y * vtoCanvas.height
            }));
            vtoCtx.moveTo(upperLipPoints[0].x, upperLipPoints[0].y);
            for (let i = 1; i < upperLipPoints.length; i++) {
                vtoCtx.lineTo(upperLipPoints[i].x, upperLipPoints[i].y);
            }
            vtoCtx.closePath();
            vtoCtx.fill();

            // Draw Lower Lip - Adjusted for mirrored video
            vtoCtx.beginPath();
            const lowerLipPoints = LIP_OUTLINE_LOWER.map(idx => ({
                // Flip X coordinate: (1 - normalizedX) * canvasWidth
                x: (1 - landmarks[idx].x) * vtoCanvas.width, 
                y: landmarks[idx].y * vtoCanvas.height
            }));
            vtoCtx.moveTo(lowerLipPoints[0].x, lowerLipPoints[0].y);
            for (let i = 1; i < lowerLipPoints.length; i++) {
                vtoCtx.lineTo(lowerLipPoints[i].x, lowerLipPoints[i].y);
            }
            vtoCtx.closePath();
            vtoCtx.fill();
            
            vtoStatus.style.display = 'none'; // Hide status if drawing is successful
        }

        async function detectionLoop() {
            if (!advancedVtoAvailable || !faceLandmarker) {
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                if (!advancedVtoAvailable) activateStaticPreview();
                return;
            }

            if (vtoVideo.readyState >= HTMLMediaElement.HAVE_ENOUGH_DATA && !vtoVideo.paused && !vtoVideo.ended) {
                if (vtoVideo.videoWidth > 0 && vtoVideo.videoHeight > 0) {
                    if (vtoCanvas.width !== vtoVideo.videoWidth || vtoCanvas.height !== vtoVideo.videoHeight) {
                        vtoCanvas.width = vtoVideo.videoWidth;
                        vtoCanvas.height = vtoVideo.videoHeight;
                        console.log(`Canvas dimensions updated to: ${vtoCanvas.width}x${vtoCanvas.height}`);
                    }

                    const currentTime = performance.now();
                    if (vtoVideo.currentTime !== lastVideoTime) { 
                        lastVideoTime = vtoVideo.currentTime;
                        try {
                            const faceLandmarkerResult = faceLandmarker.detectForVideo(vtoVideo, currentTime);
                            
                            if (faceLandmarkerResult && faceLandmarkerResult.faceLandmarks && faceLandmarkerResult.faceLandmarks.length > 0) {
                                drawLipstick(faceLandmarkerResult.faceLandmarks[0]); 
                                vtoStatus.style.display = 'none';
                            } else {
                                vtoCtx.clearRect(0, 0, vtoCanvas.width, vtoCanvas.height); 
                                vtoStatus.textContent = "Không tìm thấy khuôn mặt.";
                                vtoStatus.style.display = 'block';
                            }
                        } catch (error) {
                            console.error("Lỗi trong quá trình nhận diện khuôn mặt (MediaPipe):", error);
                            vtoStatus.textContent = "Lỗi nhận diện. Thử lại.";
                            vtoStatus.style.display = 'block';
                        }
                    }
                }
            }
            animationFrameId = requestAnimationFrame(detectionLoop);
        }

        async function startVTO() {
            vtoStatus.textContent = "Đang tải...";
            advancedVtoAvailable = await createFaceLandmarker();

            if (!advancedVtoAvailable) {
                console.log("Khởi tạo AI thất bại. Chuyển sang xem trước tĩnh.");
                activateStaticPreview();
                return;
            }
            
            const webcamReady = await setupWebcam();
            if (!webcamReady) {
                console.log("Không thể khởi động webcam. Chuyển sang xem trước tĩnh.");
                advancedVtoAvailable = false; 
                activateStaticPreview(); 
                return;
            }
            
            activateAdvancedPreview();
            console.log("VTO nâng cao đã sẵn sàng. Bắt đầu vòng lặp nhận diện.");
            
            vtoVideo.oncanplay = () => {
                if (advancedVtoAvailable) {
                    if (animationFrameId) cancelAnimationFrame(animationFrameId); 
                    lastVideoTime = -1; 
                    detectionLoop();
                }
            };
            if (vtoVideo.readyState >= HTMLMediaElement.HAVE_ENOUGH_DATA && !vtoVideo.paused) {
                 if (advancedVtoAvailable) {
                    if (animationFrameId) cancelAnimationFrame(animationFrameId);
                    lastVideoTime = -1;
                    detectionLoop();
                }
            }
        }
        
        setTimeout(startVTO, 100);

    </script>
</body>
</html>
